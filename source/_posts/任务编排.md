---
title: 任务编排
abbrlink: 394f6975
date: 2024-02-27 21:10:21
tags: dag、Serverless Workflow、工作流
---

# 背景

在实际应用中，业务逻辑往往涉及多个步骤和模块，需要协同工作才能完成整体任务。而任务编排通过将多个函数组织成有序的执行流程，使得开发者能够更自然地表达和管理复杂的业务逻辑。这种能力，业界称之为：工作流（Serverless
Workflow）or dag引擎（本文无特殊说明，用dag引擎代表）。举些例子：

## 切片加速流程图

![](/images/slice_dag_1.png)

## 转码流程图

![](/images/tc_dag_2.png)

以上业务流程，可以通过代码硬编码写死，也可以通过dag引擎来编排业务。它们之间的优缺点如下：

 类别      | 优点                                         | 缺点                                                | 备注 |
---------|--------------------------------------------|---------------------------------------------------|----|
 硬编码写死   | 1、简单、快速<br/>2、系统部署成本低                      | 1、业务发展起来后，代码非常变成屎山，难以维护<br>2、                     |
 dag引擎编排 | 1、专业人员干专有事<br/>2、对写算子的人员要求低，一旦熟悉后，能够快速落地业务 | 1、dag引擎难于稳定下来<br/>2、对dag引擎的人员成本要求高 + 系统部署成本高<br/> |

备注：业界一搜一大把，争议挺多，本文仅补充以下3点：
1、dag引擎非新鲜事物，发展了20几年了，无数人写了无数多的0~1的引擎，但是，至今无一人将dag引擎一统“天下”（或者：公司）。
2、初创业务，非常不建议自建dag引擎，容易被它拖累，特别是：人力成本。
3、一旦产品 or 业务发展到大后期，dag引擎很容易成为成本大头，特别是：人力成本。

# 架构设计

设计一款满足：云处理场景下的工作流引擎，包括以下模块：（先凑合着看，后续再补充）
![](/images/dag_1.png)

## 节点设计

 节点类型   | 作用                              | 功能说明 | 备注 |
--------|---------------------------------|------|----|
 开始节点   | 执行dag引擎的开始动作                    |      |    | 
 结束节点   | 执行dag引擎后的结束动作                   |      |    |
 路由节点   | 上一个节点执行完后，根据一定的路由执行下一个节点        |      |    |
 同步处理节点 | 短时间之内即可处理完                      |      |    |
 异步处理节点 | 处理时长长，无法同步等待，后续回调，找到对应的执行节点继续处理 |      |    |
 并行节点   | 切片后，有多个结果，需并行处理                 |      |    |
 回调节点   | 异步回调，通知业务方处理结果                  |      |    |
 脚本节点   | 书写脚本的节点，提供灵活插入脚本口子              |      |    |

## 执行引擎

## 任务追踪

 名词      | 解释 | 关系                            | 说明                    | 备注                                   |
---------|----|-------------------------------|-----------------------|--------------------------------------|
 task    | 任务 | 一次请求，对应一笔任务                   | 一笔切片请求，对应一笔任务         | 可使用UUID生成唯一的：task_id                 |
 event   | 事件 | task 与event 是一对多的关系           | 一个dag节点，对应一个事件        | event_id = task_id + "_" + node_name |
 segment | 片  | event 与 segment 是一对多的关系       | 一个视频片，对应一个event       | segment_id = event_id + "_" + order  |
 trace   | 跟踪 | trace 与 event、segment 是一对多的关系 | 一次cpu、gpu计算，对应一次trace | 可使用UUID生成唯一的：trace_id                |

## 执行计划优化

业务dag与代码执行dag往往有差异。

## dag剪枝

# mysql库表设计

## 任务表：cloud_process_task

 字段名         | 类型          | 描述                           |
-------------|-------------|------------------------------|
 id          | long        | 库表id，自增                      |
 creator     | varchar(32) | 创建者                          |
 modifier    | varchar(32) | 修改者                          |
 create_time | datetime    | 创建时间                         |
 modify_time | datetime    | 修改时间                         |
 task_id     | varchar(64) | 自动生成的UUID，索引                 |
 task_params | text        | 任务请求参数                       |
 dag_code    | varchar(64) | dag的标识符                      |
 task_result | text        | 任务结果表                        |
 total_cost  | int(10)	    | 任务处理总耗时                      |
 task_status | char(1)     | 0：成功 <br/>1：正在进行 <br/>9：运行失败 |

## 事件表：cloud_process_event

 字段名          | 类型           | 描述                                    |
--------------|--------------|---------------------------------------|
 id           | long         | 库表id，自增                               |
 creator      | varchar(32)  | 创建者                                   |
 modifier     | varchar(32)  | 修改者                                   |
 create_time  | datetime     | 创建时间                                  |
 modify_time  | datetime     | 修改时间                                  |
 task_id      | varchar(64)  | 关联：cloud_process_task的task_id         |
 event_id     | varchar(128) | event_id = task_id + "_" + node_name  |
 node_name    | varchar(64)  | 节点名称                                  |
 event_status | char(1)      | 0：成功 <br/>1：正在进行 <br/>9：运行失败          |
 exec_cnt     | int(10)      | 执行次数，大部分情况下：1次,重试次数 = 执行次数 - 1        |
 segment_cnt  | int(10)      | 分片数量,0：如果没有分片，则分片数量为：0,有分片，则输入对应的分片数量 |
 event_result | text         | 任务结果表                                 |
 total_cost   | int(10)	     | 事件处理总耗时                               |

## 分片表：cloud_process_segment

 字段名            | 类型           | 描述                                   |
----------------|--------------|--------------------------------------|
 id             | long         | 库表id，自增                              |
 creator        | varchar(32)  | 创建者                                  |
 modifier       | varchar(32)  | 修改者                                  |
 create_time    | datetime     | 创建时间                                 |
 modify_time    | datetime     | 修改时间                                 |
 task_id        | varchar(64)  | 关联：cloud_process_task的task_id        |
 event_id       | varchar(128) | event_id = task_id + "_" + node_name |
 segment_id     | varchar(256) | segment_id = event_id + "_" + order  |
 exec_cnt       | int(10)      | 执行次数，大部分情况下：1次,重试次数 = 执行次数 - 1       |
 segment_order  | int(10)      | 分片顺序号                                |
 segment_status | int(10)      | 0：成功 <br/>1：正在进行 <br/>9：运行失败         |
 total_cost     | int(10)	     | 分片处理总耗时                              |

## 分片表：cloud_process_trace

 字段名             | 类型             | 描述                            |
-----------------|----------------|-------------------------------|
 id              | long           | 库表id，自增                       |
 creator         | varchar(32)    | 创建者                           |
 modifier        | varchar(32)    | 修改者                           |
 create_time     | datetime       | 创建时间                          |
 modify_time     | datetime       | 修改时间                          |
 task_id         | varchar(64)    | 关联：cloud_process_task的task_id |
 trace_id        | varchar(128)   | 计算服务的跟踪id                     |
 trace_status    | int(10)        | 0：成功 <br/>1：正在进行 <br/>9：运行失败  |
 request_params  | text           | 请求参数                          |
 request_url     | varchar(2048)	 | 请求地址                          |
 response_result | text	          | 响应报文                          |
 callback_result | text	          | 回调报文                          |
 total_cost      | int(10)	       | 分片处理总耗时                       |

# 相关痛点