---
title: 任务编排
abbrlink: 394f6975
date: 2024-02-27 21:10:21
tags: dag、Serverless Workflow、工作流
---

# 背景

在实际应用中，业务逻辑往往涉及多个步骤和模块，需要协同工作才能完成整体任务。而任务编排通过将多个函数组织成有序的执行流程，使得开发者能够更自然地表达和管理复杂的业务逻辑。这种能力，业界称之为：工作流（Serverless
Workflow）or dag引擎（本文无特殊说明，用dag引擎代表）。举些例子：

## 切片加速流程图

![](/images/slice_dag_1.png)

## 转码流程图

![](/images/tc_dag_2.png)

以上业务流程，可以通过代码硬编码写死，也可以通过dag引擎来编排业务。它们之间的优缺点如下：

 类别      | 优点                                         | 缺点                                                                          | 备注 |
---------|--------------------------------------------|-----------------------------------------------------------------------------|----|
 硬编码写死   | 1、简单、明了<br/>2、系统部署成本低                      | 1、业务发展起来后，代码非常变成屎山，难以维护<br>2、                                               |
 dag引擎编排 | 1、专业人员干专有事<br/>2、对写算子的人员要求低，一旦熟悉后，能够快速落地业务 | 1、dag引擎难于稳定下来<br/>2、对dag引擎的人员成本要求高 + 系统部署成本高<br/>3、一旦业务发展到大后期，dag引擎往往会成为累赘。 |

备注：业界一搜一大把，争议挺多，本文仅补充以下3点：
1、dag引擎非新鲜事物，发展了20几年了，无数人写了无数多的0~1的引擎，但是，至今无一人将dag引擎一统“天下”（或者：公司）。
2、初创业务，非常不建议自建dag引擎，容易被它拖累，特别是：人力成本。
3、一旦产品 or 业务发展到大后期，dag引擎很容易成为成本大头，特别是：人力成本。

# 架构设计

设计一款满足：云处理场景下的工作流引擎，包括以下模块：（先凑合着看，后续再补充）
![](/images/dag_1.png)

## dag

## 节点设计

 节点类型   | 作用                              | 功能说明 | 备注 |
--------|---------------------------------|------|----|
 开始节点   | 执行dag引擎的开始动作                    |      |    | 
 结束节点   | 执行dag引擎后的结束动作                   |      |    |
 路由节点   | 上一个节点执行完后，根据一定的路由执行下一个节点        |      |    |
 同步处理节点 | 短时间之内即可处理完                      |      |    |
 异步处理节点 | 处理时长长，无法同步等待，后续回调，找到对应的执行节点继续处理 |      |    |
 并行节点   | 切片后，有多个结果，需并行处理                 |      |    |
 回调节点   | 异步回调，通知业务方处理结果                  |      |    |
 脚本节点   | 书写脚本的节点，提供灵活插入脚本口子              |      |    |

## 执行引擎

## 任务追踪

 名词      | 解释 | 关系                            | 说明                    | 备注                                   |
---------|----|-------------------------------|-----------------------|--------------------------------------|
 task    | 任务 | 一次请求，对应一笔任务                   | 一笔切片请求，对应一笔任务         | 可使用UUID生成唯一的：task_id                 |
 event   | 事件 | task 与event 是一对多的关系           | 一个dag节点，对应一个事件        | event_id = task_id + "_" + node_name |
 segment | 片  | event 与 segment 是一对多的关系       | 一个视频片，对应一个event       | segment_id = event_id + "_" + order  |
 trace   | 跟踪 | trace 与 event、segment 是一对多的关系 | 一次cpu、gpu计算，对应一次trace | 可使用UUID生成唯一的：trace_id                |

## 执行计划优化

业务dag与代码执行dag往往有差异。

## dag剪枝

# 相关痛点