---
title: 视频切片并行加速
tags: video slice speed up
---
# 背景
在实际业务中，视频处理，大都时候都挺费时的。例如：以下表格是，某中算法，在不同分辨率、帧率下的，cpu计算耗时体系（不包括：上传、下载的耗时）：<br>
分辨率 | 帧数  | 处理时长 / 视频时长 |
------|-----|-------------|
720p | 30帧 | 2         |
720p | 60帧 | 4         |
1080p | 30帧 | 3        |
1080p | 60帧 | 6        |
2k | 30帧 | 3.5         |
2k | 60帧 | 8           |
4k | 30帧 | 7           |
4k | 60帧 | 20          |

另外，一般情况下，视频越长，所占用的cpu or gpu，也就越久。如此，有以下弊端：
1、对于用户而言，耗时久，体验非常不好，有可能直接放弃了。
2、很容易造成资源负载不均，例如：有些机器比较倒霉，每次分配的都是：长视频（5min以上），有些机器比较luck，分配的大都都是：短视频（30s以内）
3、超过1h的视频，单台物理机，基本上不太可能能够处理完毕。姑且不谈cpu，内存都有可能爆满。

# 解决思路

## 资源扩容
 例如：某一个算法，目前部署在：8核cpu上，假设不差钱,或者：太紧急，就继续往上调整：16核 -> 32核 -> 64核 -> 128核等等
 当然了，资源也是有限的，有时候，并非每次都能通过扩容来解决。
 
## 更新硬件技术
 假设不差钱，上：更强型号的cpu or 更强型号的gpu。可惜：往往就是差钱。
 另外，就算最强的CPU，在面对：长视频 + 高帧率 + 高分辨率的情况下，也有力不从心的时候。

## 切片加速
往往实际项目，总是要求：成本优化、性能优化，
那么，切片加速，是一种比较实用的的解决方案，其总体流程：切片 -> 并行 -> 合并。如下图所示：
![](/images/slice_speed_up.png)
备注：
1、这要求：视频片与片之间，没有关联性，然后，利用并行处理，来提高处理速度 + 降低对硬件的需求。
2、假设：视频片与片之间，有上下文的关联性，那么就得：分析下关联性有什么特点，然后，将这个关联性降维到：无关联性，其整体流程就有可能会变成：切 -> 切 -> 合 -> 并 -> 合，相当于上面流程的变形。
3、提取音频时，直接做音频转码，属于：旁路并行流程。
4、切片 + 处理，需并行处理，是能够提速的关键。

# 模块抽象
模块 | 功能定位                       | 是否连db | 是否上传 or 下载 | 并发度                              |
----|----------------------------|-------|------------|----------------------------------|
总控集群| 切片策略、算法编排、任务重试、任务取消、优先级调度等 | 是     | 否          | 高，单个pod基本上要达到300QPS以上(8核cpu，经验值) |
计算集群| 原子化cpu、gpu计算，负责：算          | 否     | 是          | 低，单个pod一般处理：2个以内的视频 or 5个以内的图片（经验值）|

## 总控进程
功能 | 重要性   | 说明                               | 备注   |
----|-------|----------------------------------|-------|
切片策略 | top 0 | 描述一个视频该怎么切片，按帧切？还是按视频时长切？        | | 
算法编排 | top 1 | 切片、音频提取、视频合并、音视合并等各个阶段编排在一起，整体流程 | |
任务重试 | top 0 | 理论上，该任务可以重试，重新触发计算，不影响结果         | |
check bill | top 1 | 当一个任务，卡死，如何触发流转下去                | |


# 库表设计

