---
title: 资源调度.md
date: 2024-02-27 21:07:22
tags:
---

# 背景

云端图片、视频处理，非常费cpu or gpu，相对应的成本也非常的贵，同等业务条件下，mysql + redis + mc的成本加起来，跟cpu or
gpu的成本比起来，就是小屋见大屋了。

# 痛点梳理

## 负载不均

因不同业务请求里面的视频复杂性：例如：大小、时长均不一致，长时间跑起来，有可能会导致：有些cpu忙死，有些cpu闲死。

## 波峰波谷

大部分业务，都有此类特点，例如：晚上7点 ~ 晚上11点，波峰，但是：凌晨1点 ~ 凌晨7点，又是波谷。如果机器都按照：波峰时准备，那么，整个集群的利用率大概率不会超过：10%

## 混部

1、有些gpu机器里，也是部署了cpu的，可以利用的
2、有些计算任务，可以用cpu来算，也可以用gpu来计算，在画质ok的情况下，其实，可以相互调度的

# 解决方案

以下策略，得根据实际情况，相互配合使用的，并非：互斥关系。

## 虚拟化

## 设置合理阈值

## 资源分类

## 被动调度

监听某个指标，如果大于预设的值，则采取某种扩容策略，小于预设的值，则采取缩容的策略。举些例子：

策略1：监听cpu的使用率，如果长时间高于60%，则逐步扩容多少个pod，反之，亦然。
策略2：监听内存使用率，如果长时间高于：90%，则逐步扩容多少个pod，反之，亦然。
策略3：从某个监控指标上（例如：grafana or 普罗米修斯） 获取数据，如果某个指标大于某个预设的值，则逐步扩容多少个pod，反之，亦然。
策略4：从kafka的堆积lag数获取数据，如果大于某个预设的值，则逐步扩容多少个pod，反之，亦然。

## 主动调度

业务代码（例如：网关处），分析业务指标（例如：输入视频的时长、输入视频的大小） + 监控指标（当前cpu池子的负载情况），主动创建合适的cpu池子，来处理当前的业务请求。

## 定时调度

既然业务有波峰 + 波谷的特点，那么，可以按照业务的波峰波谷的时间，定时扩缩容cpu or gpu 池子。举个例子：

 时间区间          | 操作 | pod 区间           | 备注 |
---------------|----|------------------|----|
 凌晨1点 ~ 凌晨7点   | 缩容 | 1 < pod个数 < 10   |    |    
 早上8点 ~ 早点12点  | 扩容 | 5 < pod个数 < 50   |    |
 中午12点 ~ 下午14点 | 缩容 | 2 < pod个数 < 20   |    |
 中午15点 ~ 下午17点 | 不变 | 2 < pod个数 < 20   |    |
 中午17点 ~ 下午19点 | 扩容 | 10 < pod个数 < 60  |    |
 中午19点 ~ 下午22点 | 扩容 | 60 < pod个数 < 120 |    |
 中午22点 ~ 凌晨1点  | 缩容 | 1 < pod个数 < 10   |    |

备注：
1、以上仅仅只是举个例子，具体配置，得根据具体项目来分析。