---
title: é¢„è®¡ç®—
abbrlink: 8e265673
date: 2025-11-08 17:30:20
tags:
---

ä¸€ã€åŠŸèƒ½ç›®æ ‡

å½“æ–‡ä»¶ä¸Šä¼ å®Œæ¯•ï¼ˆæ— è®ºæ˜¯é€šè¿‡ SDK / API / æ§åˆ¶å°ä¸Šä¼ ï¼‰ï¼Œç³»ç»Ÿèƒ½å¤Ÿè‡ªåŠ¨è§¦å‘å¯¹åº”çš„ åå¤„ç†åŠ¨ä½œï¼Œä¾‹å¦‚ï¼š

ğŸ è§†é¢‘è‡ªåŠ¨è½¬ç 

ğŸ–¼ å›¾ç‰‡ç¼©ç•¥å›¾ç”Ÿæˆ

ğŸ§  AI å†…å®¹åˆ†æï¼ˆå¦‚æ ‡ç­¾è¯†åˆ«ã€äººè„¸æ£€æµ‹ï¼‰

ğŸª£ å…ƒæ•°æ®åŒæ­¥ / CDN åˆ·æ–° / æ—¥å¿—ä¸ŠæŠ¥

ç›®æ ‡æ˜¯ï¼š

è§£è€¦ä¸Šä¼ ä¸åå¤„ç†ï¼›

æ”¯æŒçµæ´»æ‰©å±•ï¼›

æ”¯æŒå¼‚æ­¥é«˜å¯ç”¨ã€‚

äºŒã€ç³»ç»Ÿæµç¨‹å›¾ï¼ˆé€»è¾‘æ¶æ„ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload SDK / API â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ ä¸Šä¼ æˆåŠŸå›è°ƒ
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Upload Service â”‚
â”‚ (ç»Ÿä¸€ä¸Šä¼ æ¥å…¥å±‚)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
æŸ¥è¯¢ cloud_process_pre_action
â”‚
â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PreAction Dispatcher â”‚
â”‚  (åŠ¨ä½œåˆ†å‘æ¨¡å—ï¼ŒåŒ¹é…è§¦å‘æ¡ä»¶)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ â”‚
â–¼ â–¼ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MQ Producer â”‚ â”‚ Webhook Caller â”‚ â”‚ Local Worker â”‚
â”‚ (Kafka/Rabbit)  â”‚ â”‚ (HTTP æ¨é€)     â”‚ â”‚ (åŒæ­¥ä»»åŠ¡)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚
â–¼ â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Consumer â”‚ â”‚ Third-Party API â”‚
â”‚ Worker Poolâ”‚ â”‚ (AI/è½¬ç /ETLç­‰)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ’¡ è®¾è®¡è¯´æ˜ï¼š

Upload Service æ˜¯ç»Ÿä¸€å…¥å£ï¼Œå¯å†…åµŒäºæ–‡ä»¶ç½‘å…³æ¨¡å—ã€‚

Dispatcher æŸ¥è¯¢ cloud_process_pre_action è¡¨ï¼Œæ ¹æ®è§„åˆ™åŒ¹é…å“ªäº›åŠ¨ä½œéœ€è¦è§¦å‘ã€‚

åŠ¨ä½œè§¦å‘æ”¯æŒä¸‰ç§æ¨¡å¼ï¼š

MQ æ¨¡å¼ï¼šå¼‚æ­¥é˜Ÿåˆ—ï¼ˆæ¨èï¼‰

Webhook æ¨¡å¼ï¼šç›´è¿ä¸‹æ¸¸æœåŠ¡ï¼ˆé€‚åˆå†…éƒ¨ç³»ç»Ÿï¼‰

Local Worker æ¨¡å¼ï¼šè½»é‡åŒ–åŒæ­¥å¤„ç†ï¼ˆé€‚åˆå°ä¸šåŠ¡ï¼‰

ä¸‰ã€äº‹ä»¶æ—¶åºå›¾ï¼ˆSequence Diagramï¼‰

ä»¥ä¸‹ä¸ºä¸€æ¬¡ã€Œä¸Šä¼  â†’ è‡ªåŠ¨è½¬ç  + AIåˆ†æã€çš„å®Œæ•´æ—¶åºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client SDK  â”‚    â”‚ Upload Service â”‚    â”‚ PreAction Dispatcher â”‚    â”‚ PreAction Worker/Hook  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ ä¸Šä¼ è¯·æ±‚             â”‚                        â”‚                         â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚                         â”‚
â”‚                     â”‚ æ–‡ä»¶ä¸Šä¼ æˆåŠŸ             â”‚                         â”‚
â”‚                     â”‚ ç”Ÿæˆæ–‡ä»¶metaä¿¡æ¯         â”‚                         â”‚
â”‚                     â”‚ æŸ¥è¯¢ pre_action é…ç½®     â”‚                         â”‚
â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
â”‚                     â”‚                        â”‚  åŒ¹é…trigger_condition    â”‚
â”‚                     â”‚                        â”‚  ç”Ÿæˆä»»åŠ¡äº‹ä»¶(event msg)  â”‚
â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
â”‚                     â”‚ æ¨é€MQ / Webhook / æœ¬åœ°ä»»åŠ¡ â”‚                         â”‚
â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
â”‚                     â”‚                        â”‚                         â”‚
â”‚                     â”‚                        â”‚ æ‰§è¡ŒåŠ¨ä½œï¼šè½¬ç /ç¼©ç•¥å›¾/AIç­‰ â”‚
â”‚                     â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚                     â”‚                        â”‚                         â”‚
â”‚                     â”‚                        â”‚ <â”€å›è°ƒç»“æœ/æ›´æ–°çŠ¶æ€â”€â”€â”€â”€â”€â”€â”‚
â”‚                     â”‚                        â”‚                         â”‚


å››ã€è§¦å‘æœºåˆ¶é€»è¾‘ï¼ˆä¼ªä»£ç ç¤ºä¾‹ï¼‰
```go
func OnUploadComplete(fileMeta FileMeta) {
// 1. æŸ¥è¯¢è¯¥ä¸Šä¼ åœºæ™¯ç»‘å®šçš„é¢„è®¡ç®—è§„åˆ™
actions := repo.QueryPreActions(fileMeta.SceneID)

    for _, action := range actions {
        if matchCondition(fileMeta, action.TriggerCondition) {
            switch action.ExecuteMode {
            case MODE_ASYNC_MQ:
                mq.Publish(action.ActionType, fileMeta)
            case MODE_WEBHOOK:
                http.Post(action.TargetURL, fileMeta)
            case MODE_LOCAL:
                runLocalAction(action, fileMeta)
            }
        }
    }
}

```


âœ… è¯´æ˜ï¼š

matchCondition ç”¨äºåˆ¤æ–­ MIMEã€æ–‡ä»¶å¤§å°ã€æ ‡ç­¾ã€ä¸Šä¼ åœºæ™¯ç­‰æ¡ä»¶ã€‚

æ”¯æŒå¤šç§è§¦å‘æ¨¡å¼ï¼ˆå¼‚æ­¥æ¶ˆæ¯ / Webhook / æœ¬åœ°æ‰§è¡Œï¼‰ã€‚

å¯ç»“åˆä»»åŠ¡çŠ¶æ€è¡¨è®°å½•æ¯æ¬¡åŠ¨ä½œæ‰§è¡Œçš„ç»“æœã€‚

äº”ã€cloud_process_pre_action è¡¨å­—æ®µæ‰©å±•å»ºè®®
| å­—æ®µå | ç±»å‹ | æè¿° |
| ------------------------- | ------------ | ---------------------------------------------- |
| id | bigint | ä¸»é”® |
| upload_id | bigint | å…³è”ä¸Šä¼ é…ç½® |
| action_type | varchar(32)  | åŠ¨ä½œç±»å‹ï¼ˆtranscodeã€thumbnailã€aiã€syncç­‰ï¼‰ |
| action_name | varchar(64)  | è‡ªå®šä¹‰åŠ¨ä½œå |
| trigger_condition | varchar(256) | JSONè§„åˆ™ï¼š`{"mime":"image/*","size_lt":10485760}` |
| execute_mode | tinyint | 1å¼‚æ­¥(MQ) 2Webhook 3æœ¬åœ°æ‰§è¡Œ |
| target_url | varchar(256) | Webhookåœ°å€æˆ–MQ topicå |
| retry_strategy | varchar(64)  | å¤±è´¥é‡è¯•ç­–ç•¥ï¼ˆå¦‚`3x@5min`ï¼‰ |
| status | tinyint | çŠ¶æ€ï¼š1å¯ç”¨ 9å…³é—­ |
| creator / modifier | varchar(32)  | åˆ›å»º/ä¿®æ”¹è€… |
| create_time / modify_time | datetime | åˆ›å»º/ä¿®æ”¹æ—¶é—´ |

å…­ã€é¢„è®¡ç®—è§¦å‘æœºåˆ¶å®ç°å»ºè®®
| ç»„ä»¶ | è¯´æ˜ | æ¨èå®ç° |
| --------------- | ------------------ | --------------------------- |
| **MQ æ¶ˆæ¯é˜Ÿåˆ—**     | è§£è€¦ä¸Šä¼ ä¸åå¤„ç† | Kafka / RabbitMQ / RocketMQ |
| **Worker Pool** | å¼‚æ­¥æ¶ˆè´¹ä»»åŠ¡ | Go åç¨‹æ± ã€Celeryã€Sidekiq |
| **Webhook è°ƒç”¨å™¨** | ä¸å¤–éƒ¨ç³»ç»Ÿè”åŠ¨ | æ”¯æŒç­¾åæ ¡éªŒã€é‡è¯• |
| **ä»»åŠ¡æ—¥å¿—è¡¨**       | è®°å½•åŠ¨ä½œæ‰§è¡Œç»“æœ | `cloud_process_action_log`  |
| **ç¼“å­˜å±‚**         | åŠ é€Ÿ pre_action é…ç½®æŸ¥è¯¢ | Redis / Etcd |

ä¸ƒã€å¯æ‰©å±•åœºæ™¯
| åœºæ™¯ | æè¿° |
| ------------ | -------------------------- |
| **è§†é¢‘è½¬ç é“¾å¼ä»»åŠ¡** | ä¸Šä¼  â†’ è§¦å‘è½¬ç  â†’ è½¬ç å®Œæˆ â†’ å›è°ƒåˆ·æ–°CDN |
| **AIæ ‡ç­¾è¯†åˆ«**   | ä¸Šä¼ å›¾ç‰‡ â†’ AIæœåŠ¡åˆ†æ â†’ å›å†™æ ‡ç­¾åˆ°DB |
| **æ•°æ®åŒæ­¥**     | ä¸Šä¼ æˆåŠŸ â†’ è§¦å‘MetaåŒæ­¥åˆ°æœç´¢ç³»ç»Ÿ |
| **å»¶è¿Ÿå¤„ç†**     | ä¸Šä¼ åå»¶è¿Ÿè§¦å‘ï¼ˆå¦‚5åˆ†é’Ÿåç”Ÿæˆç¼©ç•¥å›¾ï¼‰ |

å…«ã€æ•´ä½“æ”¶ç›Š

âœ… è·¨äº‘èµ„æºç®¡ç†ç»Ÿä¸€åŒ–
âœ… ä¸Šä¼ ä¸åå¤„ç†è§£è€¦
âœ… æ”¯æŒå¤šåè®®ä¸å¤šæ‰§è¡Œé€šé“
âœ… æ˜“äºæ‰©å±•ï¼ˆé…ç½®é©±åŠ¨ï¼Œæ— éœ€æ”¹ä»£ç ï¼‰
âœ… æ”¯æŒç°åº¦ä¸å›æ»š